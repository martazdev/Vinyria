---
import Layout from '../../layouts/Layout.astro';
import ProductCard from '../../components/ProductCard.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Get unique categories
const categories = ['All', ...new Set(posts.map((post) => post.data.category))];

// Handle category filtering (server-side for initial render if using query params, 
// but for static site, usually we'd use client-side or separate routes. 
// For simplicity in this index, we list all, but could add basic JS filtering or just links)
// Here we will list ALL posts.
---

<Layout title="All Reviews - Vinyria" description="Browse our extensive library of hands-on reviews and comparisons.">
  <section class="bg-slate-900 text-white py-16">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-4xl font-bold mb-4">All Reviews</h1>
      <p class="text-slate-300 text-lg max-w-2xl mx-auto">
        Deep dives into the latest tech, home gear, and software.
      </p>
    </div>
  </section>

  <section class="py-16 container mx-auto px-4">
    <div id="posts-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 transition-opacity duration-300">
        {posts.map((post) => (
          <div class="post-item" data-category={post.data.category}>
            <ProductCard
                title={post.data.title}
                image={post.data.heroImage || '/placeholder-hero.jpg'}
                rating={4.5} 
                price="Check Price"
                link={`/blog/${post.slug}`}
                badge={post.data.category}
            />
          </div>
        ))}
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-20">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 text-slate-400 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
        </div>
        <h3 class="text-xl font-bold text-slate-900 mb-2">Nothing Found</h3>
        <p class="text-slate-500">We couldn't find any reviews in this category yet.</p>
        <a href="/blog" class="inline-block mt-6 text-emerald-700 font-semibold hover:underline" onclick="window.history.pushState({}, '', '/blog'); window.dispatchEvent(new Event('popstate')); return false;">View all reviews</a>
    </div>
  </section>

  <script>
    function filterPosts() {
        const params = new URLSearchParams(window.location.search);
        const category = params.get('category');
        const posts = document.querySelectorAll('.post-item');
        const emptyState = document.getElementById('empty-state');
        const grid = document.getElementById('posts-grid');
        const title = document.querySelector('h1');
        
        let visibleCount = 0;

        // Update Title
        if (title) {
            title.textContent = category ? `${category} Reviews` : 'All Reviews';
        }

        posts.forEach(post => {
            const postCategory = post.getAttribute('data-category');
            if (!category || postCategory === category) {
                post.classList.remove('hidden');
                visibleCount++;
            } else {
                post.classList.add('hidden');
            }
        });

        // Toggle Empty State
        if (visibleCount === 0) {
            emptyState.classList.remove('hidden');
            grid.classList.add('hidden');
        } else {
            emptyState.classList.add('hidden');
            grid.classList.remove('hidden');
        }
    }

    // Run on load
    filterPosts();

    // Listen for history changes (if using the 'View all' link script)
    window.addEventListener('popstate', filterPosts);
  </script>
</Layout>
